name: Deploy Vite App to GitHub Pages (CI/CD)

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Record start time
        id: start_time
        run: echo "start_time=$(date +%s)" >> $GITHUB_ENV

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: npm ci

      - name: Build Vite app
        run: npm run build

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist

      - name: Calculate duration
        id: duration
        run: |
          end_time=$(date +%s)
          duration=$((end_time - $start_time))
          echo "duration=${duration}" >> $GITHUB_ENV

      - name: Notify Slack (Success)
        if: success()
        run: |
          mins=$((duration / 60))
          secs=$((duration % 60))
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\":rocket: Deployment succeeded!\n:white_check_mark: Project: ram-jamolod\n:herb: Branch: master\n:bust_in_silhouette: By: $GITHUB_ACTOR\n:link: View live site: https://ramjam97.github.io/ram-jamolod/\n:stopwatch: Duration: ${mins}m ${secs}s\n:gear: Action: Deploy Vite App to GitHub Pages (CI/CD)\n:page_facing_up: Commit: ${GITHUB_SHA:0:7}\n:hammer_and_wrench: Actions URL: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify Slack (Failure)
        if: failure()
        run: |
          curl -X POST -H 'Content-type: application/json' \
          --data "{\"text\":\":x: Deployment failed!\n:herb: Branch: master\n:bust_in_silhouette: By: $GITHUB_ACTOR\n:gear: Action: Deploy Vite App to GitHub Pages (CI/CD)\n:page_facing_up: Commit: ${GITHUB_SHA:0:7}\n:hammer_and_wrench: Actions URL: https://github.com/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}\"}" \
          ${{ secrets.SLACK_WEBHOOK_URL }}
